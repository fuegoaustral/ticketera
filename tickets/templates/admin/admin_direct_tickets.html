{% extends "admin/base_site.html" %}
{% load static %}

{% block extrahead %}
    <style>
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }

        .filter-box {
            margin-bottom: 20px;
        }

        .filter-input {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .table-wrapper {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            margin-bottom: 20px;
        }

        .tickets-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 12px;
        }

        .tickets-table thead {
            background-color: #417690;
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .tickets-table th {
            padding: 6px 8px;
            text-align: left;
            font-weight: bold;
            font-size: 11px;
        }

        .tickets-table td {
            padding: 6px 8px;
            border-bottom: 1px solid #ddd;
            font-size: 11px;
        }

        .tickets-table tbody tr {
            cursor: pointer;
        }

        .tickets-table tbody tr:hover {
            background-color: #f5f5f5;
        }

        .tickets-table tbody tr.selected {
            background-color: #e3f2fd;
        }

        .tickets-table tbody tr.hidden {
            display: none;
        }

        .status-badge, .origin-badge {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            white-space: nowrap;
        }

        .status-available {
            background-color: #4CAF50;
            color: white;
        }

        .status-pending {
            background-color: #FF9800;
            color: white;
        }

        .status-assigned {
            background-color: #2196F3;
            color: white;
        }

        .event-selector {
            margin-bottom: 20px;
        }

        .event-selector select {
            padding: 8px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-height: 40px;
            height: auto;
            line-height: 1.5;
        }

        .redemption-form {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-top: 20px;
            display: none;
        }

        .redemption-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .user-info {
            background-color: #e8f5e9;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }

        .user-info p {
            margin: 5px 0;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }

        .btn-primary {
            background-color: #417690;
            color: white;
        }

        .btn-primary:hover {
            background-color: #205067;
        }

        .btn-primary:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="container">
        <h1>Bonos Dirigidos</h1>
        
        <form method="post" class="event-selector">
            {% csrf_token %}
            <input type="hidden" name="action" value="event"/>
            <label for="event"><strong>Evento:</strong></label>
            <select name="event" id="event" onchange="this.form.submit();">
                <option value="">Seleccionar evento</option>
                {% for event in events %}
                    <option value="{{ event.id }}"
                            {% if event.id == default_event.id %}selected{% endif %}>
                        {{ event.name }}
                    </option>
                {% endfor %}
            </select>
        </form>

        {% if default_event %}
            <div class="filter-box">
                <input type="text" 
                       id="ticket-filter" 
                       class="filter-input" 
                       placeholder="Buscar en todas las columnas (origin, name, email, amount, status, event)..."
                       autocomplete="off">
            </div>

            <div class="table-wrapper">
                <table class="tickets-table">
                    <thead>
                        <tr>
                            <th style="display: none;">ID</th>
                            <th>Origin</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Amount</th>
                            <th>Used</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="tickets-tbody">
                    {% for ticket in direct_tickets %}
                        <tr class="ticket-row" 
                            data-id="{{ ticket.id }}"
                            data-origin="{{ ticket.origin }}"
                            data-name="{{ ticket.name|lower }}"
                            data-email="{{ ticket.email|default:''|lower }}"
                            data-amount="{{ ticket.amount }}"
                            data-amount-used="{{ ticket.amount_used|default:0 }}"
                            data-status="{{ ticket.status }}"
                            data-event="{{ ticket.event.name|lower }}">
                            <td style="display: none;">{{ ticket.id }}</td>
                            <td>
                                <span class="origin-badge" style="
                                    {% if ticket.origin == 'CAMP' %}background-color: #9C27B0; color: white;
                                    {% elif ticket.origin == 'ARTE' %}background-color: #E91E63; color: white;
                                    {% elif ticket.origin == 'VOLUNTARIOS' %}background-color: #00BCD4; color: white;
                                    {% else %}background-color: #757575; color: white;{% endif %}
                                ">
                                    {{ ticket.get_origin_display }}
                                </span>
                            </td>
                            <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ ticket.name }}">{{ ticket.name }}</td>
                            <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ ticket.email|default:'-' }}">{{ ticket.email|default:"-" }}</td>
                            <td>{{ ticket.amount }}</td>
                            <td>{{ ticket.amount_used|default:0 }}</td>
                            <td>
                                <span class="status-badge" style="
                                    {% if ticket.status == 'AVAILABLE' %}background-color: #4CAF50; color: white;
                                    {% elif ticket.status == 'PENDING' %}background-color: #FF9800; color: white;
                                    {% elif ticket.status == 'ASSIGNED' %}background-color: #2196F3; color: white;
                                    {% else %}background-color: #757575; color: white;{% endif %}
                                ">
                                    {{ ticket.get_status_display }}
                                </span>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 20px;">
                                No hay bonos dirigidos para este evento.
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Formulario de redención -->
            <div id="redemption-form" class="redemption-form">
                <h2>Redimir Bono Dirigido</h2>
                <form method="post" id="redeem-form">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="redeem"/>
                    <input type="hidden" name="template_id" id="template_id"/>
                    
                    <div class="form-group">
                        <label>Bono seleccionado:</label>
                        <div id="selected-ticket-info" style="padding: 10px; background-color: #f5f5f5; border-radius: 4px;"></div>
                    </div>

                    <div class="form-group">
                        <label for="user_email">Email del usuario:</label>
                        <input type="email" name="user_email" id="user_email" required readonly/>
                        <button type="button" id="check-user-btn" class="btn btn-primary" style="margin-top: 5px;">Buscar Usuario</button>
                    </div>

                    <div id="user-info" class="user-info" style="display: none;">
                        <p><strong>Usuario encontrado:</strong></p>
                        <p><strong>Nombre:</strong> <span id="user-name"></span></p>
                        <p><strong>DNI:</strong> <span id="user-dni"></span></p>
                        <p><strong>Emails asociados:</strong></p>
                        <ul id="user-emails" style="margin: 5px 0; padding-left: 20px;"></ul>
                    </div>

                    <div id="user-not-found" style="display: none; padding: 10px; background-color: #fff3cd; border-radius: 4px; margin-top: 10px;">
                        <p>Usuario no encontrado. Por favor ingrese el email de un usuario de la ticketera.</p>
                        <input type="email" id="manual-email" placeholder="Email del usuario" style="width: 100%; margin-top: 10px;"/>
                    </div>

                    <div class="form-group">
                        <label for="quantity">Cantidad de bonos a redimir:</label>
                        <input type="number" name="quantity" id="quantity" min="1" required/>
                        <small id="max-quantity-info" style="display: block; margin-top: 5px; color: #666;"></small>
                    </div>

                    <div class="form-group">
                        <label for="order_type">Tipo de orden:</label>
                        <select name="order_type" id="order_type" required>
                            <option value="CASH_ONSITE">Compra en efectivo</option>
                            <option value="LOCAL_TRANSFER">Transferencia local</option>
                            <option value="INTERNATIONAL_TRANSFER">Transferencia internacional</option>
                            <option value="OTHER">Otros</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="notes">Notas:</label>
                        <textarea name="notes" id="notes" rows="3"></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary" id="redeem-btn" disabled>Redimir Bonos</button>
                </form>
            </div>
        {% else %}
            <div style="padding: 20px; text-align: center;">
                <p>Por favor selecciona un evento para ver los bonos dirigidos.</p>
            </div>
        {% endif %}
    </div>

    <script>
        const filterInput = document.getElementById('ticket-filter');
        const ticketRows = document.querySelectorAll('.ticket-row');
        const redemptionForm = document.getElementById('redemption-form');
        const selectedTicketInfo = document.getElementById('selected-ticket-info');
        const templateIdInput = document.getElementById('template_id');
        const userEmailInput = document.getElementById('user_email');
        const checkUserBtn = document.getElementById('check-user-btn');
        const userInfo = document.getElementById('user-info');
        const userNotFound = document.getElementById('user-not-found');
        const manualEmailInput = document.getElementById('manual-email');
        const quantityInput = document.getElementById('quantity');
        const maxQuantityInfo = document.getElementById('max-quantity-info');
        const redeemBtn = document.getElementById('redeem-btn');
        let selectedTicket = null;

        // Filtro de búsqueda
        if (filterInput) {
            filterInput.addEventListener('input', function() {
                const filterValue = this.value.toLowerCase().trim();
                
                ticketRows.forEach(function(row) {
                    const searchableText = [
                        row.getAttribute('data-id'),
                        row.getAttribute('data-origin'),
                        row.getAttribute('data-name'),
                        row.getAttribute('data-email'),
                        row.getAttribute('data-amount'),
                        row.getAttribute('data-amount-used'),
                        row.getAttribute('data-status'),
                        row.getAttribute('data-event')
                    ].join(' ').toLowerCase();
                    
                    if (filterValue === '' || searchableText.includes(filterValue)) {
                        row.classList.remove('hidden');
                    } else {
                        row.classList.add('hidden');
                    }
                });
            });
        }

        // Selección de bono
        ticketRows.forEach(function(row) {
            row.addEventListener('click', function() {
                // Remover selección anterior
                ticketRows.forEach(r => r.classList.remove('selected'));
                
                // Seleccionar nueva fila
                this.classList.add('selected');
                
                // Obtener datos del bono
                selectedTicket = {
                    id: this.getAttribute('data-id'),
                    origin: this.getAttribute('data-origin'),
                    name: this.getAttribute('data-name'),
                    email: this.getAttribute('data-email'),
                    amount: parseInt(this.getAttribute('data-amount')),
                    amountUsed: parseInt(this.getAttribute('data-amount-used')),
                    available: parseInt(this.getAttribute('data-amount')) - parseInt(this.getAttribute('data-amount-used'))
                };

                // Mostrar formulario
                selectedTicketInfo.innerHTML = `
                    <strong>${selectedTicket.name}</strong><br>
                    Origin: ${selectedTicket.origin}<br>
                    Email asociado: ${selectedTicket.email || 'No tiene email'}<br>
                    Disponible: ${selectedTicket.available} bonos
                `;
                
                templateIdInput.value = selectedTicket.id;
                userEmailInput.value = selectedTicket.email || '';
                quantityInput.max = selectedTicket.available;
                quantityInput.value = '';
                maxQuantityInfo.textContent = `Máximo disponible: ${selectedTicket.available} bonos`;
                
                // Resetear formulario
                userInfo.style.display = 'none';
                userNotFound.style.display = 'none';
                manualEmailInput.value = '';
                redeemBtn.disabled = true;
                
                redemptionForm.classList.add('active');
            });
        });

        // Buscar usuario
        if (checkUserBtn) {
            checkUserBtn.addEventListener('click', async function() {
                const email = userEmailInput.value.toLowerCase().trim();
                
                if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    alert('Por favor ingrese un email válido');
                    return;
                }

                try {
                    const response = await fetch('/admin/caja/email-has-account/', {
                        method: 'POST',
                        body: JSON.stringify({email}),
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}',
                        }
                    });

                    if (response.status === 200) {
                        const data = await response.json();
                        document.getElementById('user-name').textContent = `${data.first_name} ${data.last_name}`;
                        document.getElementById('user-dni').textContent = `${data.document_type || 'DNI'}: ${data.document_number}`;
                        
                        // Display all emails
                        const emailsList = document.getElementById('user-emails');
                        emailsList.innerHTML = '';
                        if (data.emails && data.emails.length > 0) {
                            data.emails.forEach(function(email) {
                                const li = document.createElement('li');
                                li.textContent = email;
                                emailsList.appendChild(li);
                            });
                        } else {
                            const li = document.createElement('li');
                            li.textContent = email; // Fallback to searched email
                            emailsList.appendChild(li);
                        }
                        
                        userInfo.style.display = 'block';
                        userNotFound.style.display = 'none';
                        manualEmailInput.value = '';
                        redeemBtn.disabled = false;
                    } else if (response.status === 204) {
                        userInfo.style.display = 'none';
                        userNotFound.style.display = 'block';
                        manualEmailInput.value = email;
                        manualEmailInput.addEventListener('input', function() {
                            userEmailInput.value = this.value;
                        });
                        redeemBtn.disabled = false;
                    } else if (response.status === 206) {
                        alert('El email ingresado tiene una cuenta pero no tiene los datos completos. Debe completar el perfil antes de continuar');
                        redeemBtn.disabled = true;
                    }
                } catch (e) {
                    console.error(e);
                    alert('Error al buscar usuario');
                }
            });
        }

        // Validar cantidad
        if (quantityInput) {
            quantityInput.addEventListener('input', function() {
                const quantity = parseInt(this.value) || 0;
                const max = parseInt(this.max) || 0;
                
                if (quantity > max) {
                    alert(`No puedes redimir más de ${max} bonos`);
                    this.value = max;
                }
                
                if (quantity > 0 && userEmailInput.value) {
                    redeemBtn.disabled = false;
                } else {
                    redeemBtn.disabled = true;
                }
            });
        }

        // Validar email manual
        if (manualEmailInput) {
            manualEmailInput.addEventListener('input', function() {
                userEmailInput.value = this.value;
                if (this.value && quantityInput.value > 0) {
                    redeemBtn.disabled = false;
                }
            });
        }
    </script>
{% endblock %}
