{% extends 'mi_fuego/my_tickets/index.html' %}
{% load static %}

{% block extrahead %}
    <!-- SortableJS for drag and drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
{% endblock %}

{% block submenu %}
    {% include 'mi_fuego/partials/event_admin_menu.html' %}
{% endblock %}

{% block truecontent %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="fas fa-ticket-alt me-2"></i>
                        Configuración de Tipos de Entradas
                    </h1>
                    <p class="text-muted mb-0">Gestiona los tipos de entradas para {{ event.name }}</p>
                </div>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTicketTypeModal">
                    <i class="fas fa-plus me-2"></i>
                    Nuevo Tipo de Entrada
                </button>
            </div>

            <!-- Messages -->
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}

            <!-- Ticket Types List -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list me-2"></i>
                        Tipos de Entradas
                    </h5>
                    <small class="text-muted">Arrastra y suelta para reordenar</small>
                </div>
                <div class="card-body p-0">
                    {% if ticket_types %}
                        <div id="ticket-types-list" class="ticket-types-container">
                            {% for ticket_type in ticket_types %}
                                <div class="ticket-type-item" data-ticket-type-id="{{ ticket_type.id }}">
                                    <div class="ticket-type-header">
                                        <div class="drag-handle">
                                            <i class="fas fa-grip-vertical"></i>
                                        </div>
                                        <div class="ticket-type-preview">
                                            <span class="ticket-name">{{ ticket_type.name }}</span>
                                        </div>
                                        <div class="ticket-type-actions">
                                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteTicketType({{ ticket_type.id }}, '{{ ticket_type.name }}')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="ticket-type-fields">
                                        <div class="field-row">
                                            <div class="field-group">
                                                <label class="field-label">Nombre</label>
                                                <input type="text" class="form-control" value="{{ ticket_type.name }}" data-field="name" data-ticket-type-id="{{ ticket_type.id }}">
                                            </div>
                                            <div class="field-group">
                                                <label class="field-label">Precio</label>
                                                <input type="number" class="form-control price-input" value="" data-field="price" data-ticket-type-id="{{ ticket_type.id }}" step="0.01" min="0" data-original-value="{% if ticket_type.price %}{{ ticket_type.price }}{% endif %}">
                                            </div>
                                            <div class="field-group">
                                                <label class="field-label">Cantidad</label>
                                                <input type="number" class="form-control" value="{{ ticket_type.ticket_count }}" data-field="ticket_count" data-ticket-type-id="{{ ticket_type.id }}" min="0" readonly>
                                                <small class="field-help">Va bajando a medida que se vende</small>
                                            </div>
                                        </div>
                                        
                                        <div class="field-row">
                                            <div class="field-group field-group-wide">
                                                <label class="field-label">Descripción</label>
                                                <textarea class="form-control" rows="2" data-field="description" data-ticket-type-id="{{ ticket_type.id }}">{{ ticket_type.description }}</textarea>
                                            </div>
                                        </div>
                                        
                                        <div class="field-row">
                                            <div class="field-group">
                                                <label class="field-label">Disponible Desde</label>
                                                <input type="datetime-local" class="form-control" value="{% if ticket_type.date_from %}{{ ticket_type.date_from|date:'Y-m-d\TH:i' }}{% endif %}" data-field="date_from" data-ticket-type-id="{{ ticket_type.id }}">
                                            </div>
                                            <div class="field-group">
                                                <label class="field-label">Disponible Hasta</label>
                                                <input type="datetime-local" class="form-control" value="{% if ticket_type.date_to %}{{ ticket_type.date_to|date:'Y-m-d\TH:i' }}{% endif %}" data-field="date_to" data-ticket-type-id="{{ ticket_type.id }}">
                                            </div>
                                        </div>
                                        
                                        <div class="field-row">
                                            <div class="field-group">
                                                <div class="form-check">
                                                    <input type="checkbox" class="form-check-input" id="show_in_caja_{{ ticket_type.id }}" {% if ticket_type.show_in_caja %}checked{% endif %} data-field="show_in_caja" data-ticket-type-id="{{ ticket_type.id }}">
                                                    <label class="form-check-label field-label" for="show_in_caja_{{ ticket_type.id }}">
                                                        Mostrar en Caja
                                                    </label>
                                                    <small class="field-help">Si está marcado, este tipo de entrada aparecerá en la interfaz de caja</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-ticket-alt fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No hay tipos de entradas configurados</h5>
                            <p class="text-muted">Crea tu primer tipo de entrada para comenzar</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Ticket Type Modal -->
<div class="modal fade" id="createTicketTypeModal" tabindex="-1" aria-labelledby="createTicketTypeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="create">
                <div class="modal-header">
                    <h5 class="modal-title" id="createTicketTypeModalLabel">
                        <i class="fas fa-plus me-2"></i>
                        Nuevo Tipo de Entrada
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="{{ form.name.id_for_label }}" class="form-label">Nombre</label>
                                {{ form.name }}
                                {% if form.name.errors %}
                                    <div class="text-danger">{{ form.name.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="{{ form.price.id_for_label }}" class="form-label">Precio</label>
                                {{ form.price }}
                                {% if form.price.errors %}
                                    <div class="text-danger">{{ form.price.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group mb-3">
                        <label for="{{ form.description.id_for_label }}" class="form-label">Descripción</label>
                        {{ form.description }}
                        {% if form.description.errors %}
                            <div class="text-danger">{{ form.description.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="{{ form.ticket_count.id_for_label }}" class="form-label">Cantidad</label>
                                {{ form.ticket_count }}
                                <small class="form-text text-muted">Va bajando a medida que se vende</small>
                                {% if form.ticket_count.errors %}
                                    <div class="text-danger">{{ form.ticket_count.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="{{ form.date_from.id_for_label }}" class="form-label">Disponible Desde</label>
                                {{ form.date_from }}
                                {% if form.date_from.errors %}
                                    <div class="text-danger">{{ form.date_from.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="{{ form.date_to.id_for_label }}" class="form-label">Disponible Hasta</label>
                                {{ form.date_to }}
                                {% if form.date_to.errors %}
                                    <div class="text-danger">{{ form.date_to.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-check mb-3">
                                <input type="checkbox" class="form-check-input" id="show_in_caja_new" name="show_in_caja" checked>
                                <label class="form-check-label" for="show_in_caja_new">
                                    Mostrar en Caja
                                </label>
                                <small class="form-text text-muted d-block">Si está marcado, este tipo de entrada aparecerá en la interfaz de caja</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>
                        Crear Tipo de Entrada
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteTicketTypeModal" tabindex="-1" aria-labelledby="deleteTicketTypeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" id="deleteTicketTypeForm">
                {% csrf_token %}
                <input type="hidden" name="action" value="delete">
                <input type="hidden" name="ticket_type_id" id="deleteTicketTypeId">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteTicketTypeModalLabel">
                        <i class="fas fa-exclamation-triangle me-2 text-warning"></i>
                        Confirmar Eliminación
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>¿Estás seguro de que quieres eliminar el tipo de entrada <strong id="deleteTicketTypeName"></strong>?</p>
                    <p class="text-muted">Esta acción no se puede deshacer.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-2"></i>
                        Eliminar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .ticket-types-container {
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .ticket-type-item {
        border: 1px solid #e9ecef;
        border-radius: 0.75rem;
        margin-bottom: 1rem;
        background: #fff;
        transition: all 0.3s ease;
        overflow: hidden;
    }
    
    .ticket-type-item:hover {
        border-color: #289e6d;
        box-shadow: 0 4px 12px rgba(40, 158, 109, 0.15);
        transform: translateY(-2px);
    }
    
    .ticket-type-item.sortable-ghost {
        opacity: 0.4;
        transform: rotate(2deg);
    }
    
    .ticket-type-item.sortable-chosen {
        border-color: #289e6d;
        box-shadow: 0 8px 24px rgba(40, 158, 109, 0.25);
        transform: scale(1.02);
    }
    
    .ticket-type-header {
        display: flex;
        align-items: center;
        padding: 1rem 1.5rem;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-bottom: 1px solid #e9ecef;
        gap: 1rem;
    }
    
    .drag-handle {
        cursor: grab;
        padding: 0.5rem;
        border-radius: 0.375rem;
        transition: all 0.2s ease;
        color: #6c757d;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 32px;
        height: 32px;
    }
    
    .drag-handle:hover {
        background-color: #289e6d;
        color: white;
        transform: scale(1.1);
    }
    
    .drag-handle:active {
        cursor: grabbing;
        transform: scale(0.95);
    }
    
    .ticket-type-preview {
        flex: 1;
        display: flex;
        align-items: center;
    }
    
    .ticket-name {
        font-weight: 600;
        font-size: 1.1rem;
        color: #495057;
    }
    
    .ticket-type-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .ticket-type-fields {
        padding: 1.5rem;
    }
    
    .field-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .field-row:last-child {
        margin-bottom: 0;
    }
    
    .field-group {
        display: flex;
        flex-direction: column;
    }
    
    .field-group-wide {
        grid-column: 1 / -1;
    }
    
    .field-label {
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.5rem;
        color: #495057;
    }
    
    .field-help {
        font-size: 0.75rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
    
    .form-control {
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        padding: 0.75rem;
        font-size: 0.9rem;
        transition: all 0.2s ease;
    }
    
    .form-control:focus {
        border-color: #289e6d;
        box-shadow: 0 0 0 0.2rem rgba(40, 158, 109, 0.25);
    }
    
    .form-control[readonly] {
        background-color: #f8f9fa;
        color: #6c757d;
    }
    
    textarea.form-control {
        resize: vertical;
        min-height: 60px;
    }
    
    .form-check {
        padding: 0.75rem;
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        border: 1px solid #e9ecef;
        transition: all 0.2s ease;
    }
    
    .form-check:hover {
        background-color: #e9f5f0;
        border-color: #289e6d;
    }
    
    .form-check-input {
        margin-top: 0.25rem;
    }
    
    .form-check-input:checked {
        background-color: #289e6d;
        border-color: #289e6d;
    }
    
    .form-check-label {
        font-weight: 500;
        color: #495057;
        margin-bottom: 0.25rem;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .ticket-types-container {
            max-width: 100%;
        }
        
        .ticket-type-header {
            padding: 1rem;
            flex-wrap: wrap;
        }
        
        .ticket-type-fields {
            padding: 1rem;
        }
        
        .field-row {
            grid-template-columns: 1fr;
            gap: 0.75rem;
        }
        
        .field-group-wide {
            grid-column: 1;
        }
    }
    
    @media (min-width: 1200px) {
        .field-row {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .field-group-wide {
            grid-column: 1 / -1;
        }
    }
    
    @media (min-width: 1400px) {
        .ticket-types-container {
            max-width: 1400px;
        }
        
        .field-row {
            grid-template-columns: repeat(4, 1fr);
        }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Fix price inputs to use dot as decimal separator
    const priceInputs = document.querySelectorAll('.price-input');
    priceInputs.forEach(input => {
        const originalValue = input.getAttribute('data-original-value');
        if (originalValue) {
            // Convert comma to dot for HTML number inputs
            input.value = originalValue.replace(',', '.');
        }
    });
    
    // Initialize drag and drop
    const ticketTypesList = document.getElementById('ticket-types-list');
    if (ticketTypesList) {
        new Sortable(ticketTypesList, {
            handle: '.drag-handle',
            animation: 150,
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            onEnd: function(evt) {
                // Update cardinality via AJAX
                const ticketTypeIds = Array.from(ticketTypesList.children).map(item => 
                    item.getAttribute('data-ticket-type-id')
                );
                
                fetch('{% url "ticket_types_ajax" event.slug %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: new URLSearchParams({
                        'action': 'update_cardinality',
                        'ticket_type_ids': JSON.stringify(ticketTypeIds)
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Order updated successfully');
                    } else {
                        console.error('Error updating order:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            }
        });
    }
    
    // Handle inline field updates
    const fieldInputs = document.querySelectorAll('[data-field]');
    fieldInputs.forEach(input => {
        let timeout;
        
        if (input.type === 'checkbox') {
            // Handle checkbox changes immediately
            input.addEventListener('change', function() {
                updateTicketTypeField(this);
            });
        } else {
            // Handle text inputs with debounce
            input.addEventListener('input', function() {
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    updateTicketTypeField(this);
                }, 1000); // Debounce for 1 second
            });
        }
    });
});

function updateTicketTypeField(input) {
    const ticketTypeId = input.getAttribute('data-ticket-type-id');
    const fieldName = input.getAttribute('data-field');
    const value = input.type === 'checkbox' ? input.checked : input.value;
    
    fetch('{% url "ticket_types_ajax" event.slug %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: new URLSearchParams({
            'action': 'update_field',
            'ticket_type_id': ticketTypeId,
            'field_name': fieldName,
            'value': value
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update preview if it's name
            if (fieldName === 'name') {
                updateTicketTypePreview(ticketTypeId, fieldName, value);
            }
        } else {
            console.error('Error updating field:', data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

function updateTicketTypePreview(ticketTypeId, fieldName, value) {
    const ticketTypeItem = document.querySelector(`[data-ticket-type-id="${ticketTypeId}"]`);
    if (!ticketTypeItem) return;
    
    if (fieldName === 'name') {
        const nameSpan = ticketTypeItem.querySelector('.ticket-name');
        if (nameSpan) nameSpan.textContent = value;
    }
}

function deleteTicketType(ticketTypeId, ticketTypeName) {
    document.getElementById('deleteTicketTypeId').value = ticketTypeId;
    document.getElementById('deleteTicketTypeName').textContent = ticketTypeName;
    
    const modal = new bootstrap.Modal(document.getElementById('deleteTicketTypeModal'));
    modal.show();
}
</script>
{% endblock %}
