{% extends 'mi_fuego/my_tickets/index.html' %}
{% load static %}
{% load humanize %}

{% block submenu %}
    {% include 'mi_fuego/partials/event_admin_menu.html' %}
{% endblock submenu %}

{% block truecontent %}
    <style>
        .stats-card {
            background: #fff;
            border: 1px solid #d9d9d9;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-item {
            text-align: center;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 0.5rem;
            border: 1px solid #e9ecef;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #289e6d;
            margin-bottom: 0.25rem;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .event-header {
            background: linear-gradient(135deg, #289e6d 0%, #1e7a5a 100%);
            color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            margin-bottom: 2rem;
        }
        
        .event-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .event-dates {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .event-location {
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
        
        
        .progress {
            height: 30px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        
        .progress-bar {
            background-color: #289e6d;
            border-radius: 7px;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        /* Force width calculation */
        .progress-bar[style*="width"] {
            width: var(--bar-width) !important;
        }
        
        .summary-table {
            background: #fff;
            border: 1px solid #d9d9d9;
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .summary-table th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #d9d9d9;
            font-weight: 600;
            color: #1e1e1e;
        }
        
        .summary-table td {
            border-bottom: 1px solid #e9ecef;
        }
        
        .summary-table tr:last-child td {
            border-bottom: none;
        }
        
        .highlight-row {
            background-color: #f8f9fa;
            font-weight: 600;
        }
    </style>

    <div class="container-fluid">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="event-header">
                        <div class="event-title">
                            {% if event.is_main %}
                                <i class="fas fa-star me-2"></i>
                            {% endif %}
                            {{ event.name }}
                        </div>
                        <div class="event-dates">
                            <i class="fas fa-calendar me-1"></i>
                            {{ event.start|date:'d/m/Y' }} - {{ event.end|date:'d/m/Y' }}
                        </div>
                        {% if event.location %}
                            <div class="event-location">
                                <i class="fas fa-map-marker-alt me-1"></i>
                                {% if event.location_url %}
                                    <a href="{{ event.location_url }}" target="_blank" class="text-white text-decoration-none">
                                        {{ event.location }}
                                    </a>
                                {% else %}
                                    {{ event.location }}
                                {% endif %}
                            </div>
                        {% endif %}
                        
                    </div>


                    <!-- Stats Grid -->
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value">{{ stats.regular_tickets_sold|add:stats.caja_tickets_sold }}</div>
                            <div class="stat-label">Tickets Vendidos</div>
                        </div>
                        
                        <div class="stat-item">
                            <div class="stat-value">{{ stats.tickets_used }}</div>
                            <div class="stat-label">Tickets Usados</div>
                        </div>
                        
                        <div class="stat-item">
                            <div class="stat-value">{{ stats.total_orders }}</div>
                            <div class="stat-label">Total de Órdenes</div>
                        </div>
                        
                        <div class="stat-item">
                            <div class="stat-value">${{ stats.total_revenue|floatformat:2 }}</div>
                            <div class="stat-label">Ingresos Totales</div>
                        </div>
                        
                        <div class="stat-item">
                            <div class="stat-value">${{ stats.net_received_amount|floatformat:2 }}</div>
                            <div class="stat-label">Neto Recibido</div>
                        </div>
                    </div>

                    <!-- Progress Bar for Tickets Sold -->
                    {% if event.max_tickets %}
                        <div class="stats-card">
                            <h5 class="mb-3">
                                <i class="fas fa-chart-pie me-2"></i>
                                Progreso de Ventas
                            </h5>
                            <div class="progress mb-2" role="progressbar" 
                                 aria-label="Progreso de ventas" 
                                 aria-valuenow="{{ stats.percentage_sold }}" 
                                 aria-valuemin="0" aria-valuemax="100">
                                <div class="progress-bar" 
                                     style="width: {{ stats.percentage_sold|floatformat:0 }}% !important; --bar-width: {{ stats.percentage_sold|floatformat:0 }}%; min-width: 0; flex: none;">
                                    {{ stats.percentage_sold|floatformat:1 }}%
                                </div>
                            </div>
                            <div class="d-flex justify-content-between text-muted">
                                <small>{{ stats.tickets_sold }} vendidos</small>
                                <small>{{ event.max_tickets }} máximo</small>
                            </div>
                        </div>
                    {% endif %}
                    
                    <!-- Venue Occupancy Statistics -->
                    {% if event.venue_capacity %}
                        <div class="stats-card">
                            <h5 class="mb-3">
                                <i class="fas fa-users me-2"></i>
                                Ocupación del Venue
                            </h5>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="stat-item">
                                        <div class="stat-value">{{ stats.venue_occupancy }} / {{ stats.venue_capacity }}</div>
                                        <div class="stat-label">Ocupación Actual</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="stat-item">
                                        <div class="stat-value">{{ stats.occupancy_percentage|floatformat:1 }}%</div>
                                        <div class="stat-label">Porcentaje de Ocupación</div>
                                    </div>
                                </div>
                            </div>
                            <div class="progress mb-2" role="progressbar" 
                                 aria-label="Ocupación del venue" 
                                 aria-valuenow="{{ stats.occupancy_percentage }}" 
                                 aria-valuemin="0" aria-valuemax="100">
                                <div class="progress-bar bg-info" 
                                     style="width: {{ stats.occupancy_percentage|floatformat:0 }}% !important; --bar-width: {{ stats.occupancy_percentage|floatformat:0 }}%; min-width: 0; flex: none;">
                                    {{ stats.occupancy_percentage|floatformat:1 }}%
                                </div>
                            </div>
                            <div class="d-flex justify-content-between text-muted">
                                <small>{{ stats.venue_occupancy }} ocupado</small>
                                <small>{{ stats.venue_capacity }} capacidad</small>
                            </div>
                            <div class="d-flex justify-content-between text-muted mt-1">
                                <small>{{ stats.attendees_left }} salieron</small>
                                <small>{{ stats.venue_occupancy|add:stats.attendees_left }} usados</small>
                            </div>
                        </div>
                    {% endif %}
                        
                    <!-- Alert sobre números aproximados -->
                    <div class="alert alert-info mt-3 mb-0">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-info-circle me-2 mt-1"></i>
                            <div>
                                <strong>Información importante:</strong> Estos números son aproximados y tienen fines de referencia únicamente. 
                                Los montos finales exactos, incluyendo comisiones de MercadoPago, impuestos y otros gastos, 
                                se determinarán mediante la conciliación al finalizar el evento.
                            </div>
                        </div>
                    </div>

                    <!-- Ventas Online -->
                    <div class="my-4">
                        <h6 class="mb-3"><i class="fas fa-shopping-cart me-2"></i>Ventas Online</h6>
                    </div>
                    <style>
                        .ticket-type-breakdown {
                            background-color: #f8f9fa;
                            font-size: 0.9em;
                        }
                        .ticket-type-breakdown td {
                            border-top: 1px solid #dee2e6;
                            padding: 0.5rem 0.75rem;
                        }
                        .ticket-type-emoji {
                            font-size: 1.1em;
                        }
                        .separator-row td {
                            border-top: 2px solid #dee2e6;
                            border-bottom: 2px solid #dee2e6;
                            background-color: #e9ecef;
                            height: 8px;
                        }
                    </style>
                    <div class="summary-table">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th class="text-end">Cantidad</th>
                                    <th class="text-end">Monto</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ticket_type in online_ticket_type_breakdown %}
                                <tr class="ticket-type-breakdown">
                                    <td class="ps-4">
                                        {{ ticket_type.name }}
                                    </td>
                                    <td class="text-end">{{ ticket_type.quantity_sold }} bonos</td>
                                    <td class="text-end">${{ ticket_type.gross_amount|floatformat:2 }}</td>
                                </tr>
                                {% endfor %}
                                <tr>
                                    <td><i class="fas fa-ticket-alt me-2"></i>Ingresos por Entradas</td>
                                    <td class="text-end">{{ online_ticket_total_quantity }} bonos</td>
                                    <td class="text-end">${{ online_ticket_total_gross|floatformat:2 }}</td>
                                </tr>
                                <tr class="separator-row">
                                    <td colspan="3" class="border-0 py-2"></td>
                                </tr>
                                <tr>
                                    <td><i class="fas fa-palette me-2"></i>Donaciones Arte</td>
                                    <td class="text-end">-</td>
                                    <td class="text-end">${{ stats.donations_art|floatformat:2 }}</td>
                                </tr>
                                <tr>
                                    <td><i class="fas fa-building me-2"></i>Donaciones Sede</td>
                                    <td class="text-end">-</td>
                                    <td class="text-end">${{ stats.donations_venue|floatformat:2 }}</td>
                                </tr>
                                <tr>
                                    <td><i class="fas fa-heart me-2"></i>Donaciones Beca</td>
                                    <td class="text-end">-</td>
                                    <td class="text-end">${{ stats.donations_grant|floatformat:2 }}</td>
                                </tr>
                                <tr class="highlight-row">
                                    <td><i class="fas fa-calculator me-2"></i><strong>Total Bruto</strong></td>
                                    <td class="text-end"><strong>{{ online_ticket_total_quantity }} bonos</strong></td>
                                    <td class="text-end"><strong>${{ online_ticket_total_gross|add:stats.donations_art|add:stats.donations_venue|add:stats.donations_grant|floatformat:2 }}</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Debug Section - Commission Calculation Details -->
                    <div class="mt-4 p-3 bg-light rounded">
                        <h6 class="mb-3"><i class="fas fa-info-circle me-2"></i>Detalle del Cálculo Proporcional de comisiones de MercadoPago</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <small class="text-muted">Comisiones Totales:</small>
                                <div class="fw-bold">${{ stats.mp_comisiones|floatformat:2 }}</div>
                                <small class="text-muted">({{ stats.mp_total_bruto|floatformat:2 }} - {{ stats.mp_total_neto|floatformat:2 }})</small>
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted">Porcentaje aproximado de comisión:</small>
                                <div class="fw-bold">~{{ stats.mp_porcentaje|floatformat:2 }}%</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ventas por medio de pago -->
                    {% if payment_method_breakdown %}
                    <div class="my-4">
                        <h6 class="mb-3"><i class="fas fa-credit-card me-2"></i>Ventas por medio de pago</h6>
                    </div>
                    <div class="summary-table">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th class="text-end">Órdenes</th>
                                    <th class="text-end">Bonos</th>
                                    <th class="text-end">Monto Bruto</th>
                                    <th class="text-end">Monto Neto</th>
                                    <th class="text-end">Don. Arte</th>
                                    <th class="text-end">Don. Sede</th>
                                    <th class="text-end">Don. Inclusión</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for payment_method in payment_method_breakdown %}
                                <tr>
                                    <td>
                                        <i class="fas fa-{% if payment_method.order_type == 'CASH_ONSITE' %}money-bill{% elif payment_method.order_type == 'LOCAL_TRANSFER' %}exchange-alt{% elif payment_method.order_type == 'INTERNATIONAL_TRANSFER' %}globe{% elif payment_method.order_type == 'ONLINE_PURCHASE' %}shopping-cart{% else %}credit-card{% endif %} me-2"></i>
                                        {{ payment_method.order_type_display }}
                                    </td>
                                    <td class="text-end">{{ payment_method.ordenes }}</td>
                                    <td class="text-end">{{ payment_method.bonos }}</td>
                                    <td class="text-end">${{ payment_method.total_bruto|floatformat:2 }}</td>
                                    <td class="text-end">${{ payment_method.total_neto|floatformat:2 }}</td>
                                    <td class="text-end">${{ payment_method.donaciones_arte|floatformat:2 }}</td>
                                    <td class="text-end">${{ payment_method.donaciones_sede|floatformat:2 }}</td>
                                    <td class="text-end">${{ payment_method.donaciones_inclusion|floatformat:2 }}</td>
                                </tr>
                                {% endfor %}
                                <tr class="highlight-row">
                                    <td><strong>Total</strong></td>
                                    <td class="text-end"><strong>{{ payment_method_totals.ordenes }}</strong></td>
                                    <td class="text-end"><strong>{{ payment_method_totals.bonos }}</strong></td>
                                    <td class="text-end"><strong>${{ payment_method_totals.total_bruto|floatformat:2 }}</strong></td>
                                    <td class="text-end"><strong>${{ payment_method_totals.total_neto|floatformat:2 }}</strong></td>
                                    <td class="text-end"><strong>${{ payment_method_totals.donaciones_arte|floatformat:2 }}</strong></td>
                                    <td class="text-end"><strong>${{ payment_method_totals.donaciones_sede|floatformat:2 }}</strong></td>
                                    <td class="text-end"><strong>${{ payment_method_totals.donaciones_inclusion|floatformat:2 }}</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                    
                    <!-- Total General -->
                    <div class="my-4">
                        <h6 class="mb-3"><i class="fas fa-calculator me-2"></i>Total General</h6>
                    </div>
                    <div class="summary-table">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th class="text-end">Monto Bruto</th>
                                    <th class="text-end">Monto Neto</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><i class="fas fa-receipt me-2"></i>Total (todas las ventas confirmadas)</td>
                                    <td class="text-end">${{ stats.total_revenue|floatformat:2 }}</td>
                                    <td class="text-end">${{ stats.net_received_amount|floatformat:2 }}</td>
                                </tr>
                                <tr class="highlight-row">
                                    <td><strong>TOTAL GENERAL</strong></td>
                                    <td class="text-end"><strong>${{ stats.total_revenue|floatformat:2 }}</strong></td>
                                    <td class="text-end"><strong>${{ stats.net_received_amount|floatformat:2 }}</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock truecontent %}
