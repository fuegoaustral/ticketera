{% extends 'mi_fuego/my_tickets/index.html' %}
{% load static %}
{% load humanize %}
{% load ticket_filters %}
{% block actions %}
    <!-- No action buttons needed -->
{% endblock actions %}
{% block truecontent %}

    <style>
        .tickets-container {
            scroll-behavior: smooth;
        }
        .qr img {
            max-width: 280px !important;
        }
        @media (min-width: 768px) {
            .qr img {
                max-width: 180px !important;
            }
        }
        @media (max-width: 767px) {
            .qr-container {
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
            }
            .qr {
                width: 100% !important;
                display: flex !important;
                justify-content: center !important;
            }
            .qr img {
                max-width: 100% !important;
                width: 90% !important;
                height: auto !important;
            }
            .ticket-actions {
                margin-top: 0.5rem !important;
            }
        }
        .truecontent {
            min-height: 100vh;
            display: flex;
            align-items: center;
        }
        .card {
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        .card-body {
            position: relative;
            overflow: hidden;
        }
        .card-body::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='48' height='49' viewBox='0 0 48 49' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cmask id='mask0_41_1237' style='mask-type:alpha' maskUnits='userSpaceOnUse' x='0' y='0' width='48' height='49'%3E%3Crect y='0.5' width='48' height='48' fill='%23D9D9D9'/%3E%3C/mask%3E%3Cg mask='url(%23mask0_41_1237)'%3E%3Cpath d='M24.0999 28.5461H24.098C22.2663 28.5461 20.7803 27.0598 20.7803 25.2276C20.7803 23.3961 22.2663 21.9089 24.098 21.9089H24.0999C25.9317 21.9099 27.4167 23.3961 27.4167 25.2276C27.4167 27.0598 25.9317 28.5461 24.0999 28.5461ZM30.7372 21.9089V18.5905H27.4186V15.2715H24.0999H20.7803V18.5905H17.4607V21.9089H14.1421V25.2276V28.547H17.4607V31.8647H20.7803V35.1853H24.0999H27.4186V31.8647H30.7372V28.547H34.0559V25.2276V21.9089H30.7372Z' fill='%23e0e0e0'/%3E%3Cpath d='M10.5992 7.07482C10.5992 7.07482 10.9 20.8707 12.2657 34.2834C12.2657 34.2834 18.8741 38.7346 20.7999 39.8673C20.7999 39.8673 21.4614 44.8686 21.7284 59.6545L16.321 62.3183C16.321 62.3183 18.0368 79.2153 18.8383 88.7484C18.8383 88.7484 18.3964 89.3145 15.9883 88.7484C15.9883 88.7484 12.1931 73.426 11.0692 59.3691C11.0692 59.3691 13.8207 57.406 17.9149 55.7327C17.9149 55.7327 16.7106 47.0245 16.7106 44.6008C16.7106 44.6008 10.2964 40.4259 6.72773 37.6824C6.72773 37.6824 4.4876 29.4119 3 7.07482C3 7.07482 6.21701 5.78147 10.5992 7.07482Z' fill='%23e0e0e0'/%3E%3Cpath d='M37.5993 7.07482C37.5993 7.07482 37.2996 20.8707 35.9341 34.2834C35.9341 34.2834 29.3267 38.7346 27.3983 39.8673C27.3983 39.8673 26.7389 44.8686 26.4697 59.6545L31.8799 62.3183C31.8799 62.3183 30.164 79.2153 29.3604 88.7484C29.3604 88.7484 29.8025 89.3145 32.2106 88.7484C32.2106 88.7484 36.0055 73.426 37.1304 59.3691C37.1304 59.3691 34.3789 57.406 30.2852 55.7327C30.2852 55.7327 31.489 47.0245 31.489 44.6008C31.489 44.6008 37.9031 40.4259 41.4706 37.6824C41.4706 37.6824 43.7104 29.4119 45.1982 7.07482C45.1982 7.07482 41.9823 5.78147 37.5993 7.07482Z' fill='%23e0e0e0'/%3E%3C/g%3E%3C/svg%3E");
            background-repeat: repeat;
            opacity: 0.2;
            z-index: 0;
        }
        .card-body > * {
            position: relative;
            z-index: 1;
        }
        .btn-semi-white {
            background-color: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        .btn-semi-white:hover {
            background-color: rgba(255, 255, 255, 0.9);
        }

        .calendar-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background-color: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 0.5rem;
            color: #212529;
            text-decoration: none;
            transition: all 0.3s ease;
            margin-top: 1rem;
        }

        .calendar-btn:hover {
            background-color: rgba(255, 255, 255, 0.9);
            color: #212529;
        }

        .force-hidden {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
        }
        
        .location-link {
            color: inherit;
            text-decoration: underline;
        }

        .location-link:hover {
            text-decoration: underline;
        }

        .ticket-id {
            font-weight: bold;
            margin-right: 0.5em;
            color: inherit;
        }

        /* Transfer functionality styles */
        .notice.badge {
            font-size: 0.75rem;
            padding: 0.375rem 0.75rem;
        }

        .notice.badge.lh-sm {
            line-height: 1.2;
        }

        .btn-sm {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }

        .text-decoration-none {
            text-decoration: none !important;
        }

        .text-decoration-none:hover {
            text-decoration: none !important;
        }

        /* Fire swarm animation keyframes */
        @keyframes swarm {
            0% {
                transform: translate(var(--x-start), -100vh) rotate(0deg) scale(0);
                opacity: 0;
            }
            10% {
                opacity: 1;
                transform: translate(var(--x-start), -80vh) rotate(90deg) scale(1);
            }
            80% {
                opacity: 1;
                transform: translate(var(--x-end), var(--y-end)) rotate(720deg) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(var(--x-end), var(--y-end)) rotate(1080deg) scale(0);
            }
        }

        .swarm-element {
            position: fixed;
            pointer-events: none;
            z-index: 9999;
            animation: swarm 3s ease-in-out forwards;
        }

        .swarm-element.emoji {
            font-size: 3rem;
        }

        /* Ensure ticket cards can contain the animation */
        .card[data-ticket-key] {
            position: relative;
            overflow: hidden;
        }

    </style>

    {% if not tickets_dto %}
        <div class="truecontent">
            <div class="card text-center mx-extra">
                <div class="card-body d-flex justify-content-between flex-column align-items-center main-card-spacing gap-4">
                    <h3>No tenés bonos para este evento</h3>
                    {% if has_available_tickets %}
                        <a class="btn btn-primary" href="{% url "select_tickets" %}">Comprar Bono</a>
                    {% endif %}
                </div>
            </div>
        </div>
    {% else %}
        {% if not is_volunteer and not event.volunteers_enabled_until and event.has_volunteers %}
            <div class="alert alert-info text-start">
                <div class="d-flex align-items-center gap-5 flex-wrap flex-sm-nowrap">
                    <div>
                        Fuego Austral es un encuentro participativo y todos tenemos un talento para aportar a
                        nuestra ciudad temporal. Te invitamos a sumarte al área en la que sabés que podés dar lo
                        mejor de vos.
                    </div>
                    <div>
                        <a class="btn btn-secondary text-nowrap"
                           href="{% url "volunteering" %}">Quiero ser voluntario</a>
                    </div>
                </div>
            </div>
        {% endif %}

        {% if event.has_volunteers and event.volunteer_period and not is_volunteer %}
            <div class="alert alert-info text-start">
                <div class="d-flex align-items-center gap-2">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        Tenés tiempo para <a href="{% url 'volunteering' event.slug %}" class="alert-link">postularte como voluntario</a> hasta el
                        <strong>{{ event.volunteers_enabled_until|date:'d/m' }}</strong> a las <strong>{{ event.volunteers_enabled_until|date:'H:i' }}</strong>.
                    </div>
                </div>
            </div>
        {% endif %}

        {% if unshared_tickets_count > 0 and attendee_must_be_registered and event.transfers_enabled_until >= now %}
            <div class="alert alert-warning text-start">
                <div class="d-flex align-items-center gap-2">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>
                        Tenés <strong>{{ unshared_tickets_count }}</strong> bono{{ unshared_tickets_count|pluralize:"s" }} sin compartir.<br>
                        Todos los asistentes deben estar registrados.<br>
                        Si no compartís el bono{{ unshared_tickets_count|pluralize:"s" }} antes del <strong>{{ event.transfers_enabled_until|date:'d/m' }}</strong> a las <strong>{{ event.transfers_enabled_until|date:'H:i' }}</strong>, el bono{{ unshared_tickets_count|pluralize:"s" }} se perderá.
                    </div>
                </div>
            </div>
        {% endif %}

        {% if not attendee_must_be_registered %}
            <div class="alert alert-info text-start">
                <div class="d-flex align-items-center gap-2">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        Para este evento no hace falta que los invitados tengan su cuenta. Podés compartir el bono haciendo clic en el botón "Compartir" o tomando una captura de pantalla.
                    </div>
                </div>
            </div>
        {% endif %}

        {% if attendee_must_be_registered and event.transfers_enabled_until >= now and not has_owner_tickets and has_holder_tickets %}
            <div class="alert alert-warning text-start">
                <div class="d-flex align-items-center gap-2">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>
                        No tenés bonos vinculados a tu cuenta. Si vas a asistir al evento, es necesario que tengas al menos un bono vinculado a tu usuario para poder ingresar.
                    </div>
                </div>
            </div>
        {% endif %}

        <div class="alert alert-info text-start">
            <div class="d-flex align-items-center gap-2">
                <i class="fas fa-info-circle"></i>
                <div class="flex-grow-1">
                    <strong>Recomendación importante:</strong> Te recomendamos tomar una captura de pantalla o descargar el bono en PDF, ya que puede no haber buena conexión a internet en el terreno. Podés descargar el bono usando el botón de descarga en cada bono.
                </div>
            </div>
        </div>
            
        {% for ticket in tickets_dto %}
            <div class="card my-4 border" data-ticket-key="{{ ticket.key }}" style="position: relative;">
                {% if ticket.is_used %}
                    <div class="used-tag" style="position: absolute; top: 10px; right: 10px; background: #dc3545; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; z-index: 10; text-transform: uppercase; letter-spacing: 0.5px;">USADO</div>
                {% endif %}
                <div class="card-header {% if not ticket.is_used %}bg-success text-white{% endif %} d-flex justify-content-between align-items-center">
                    <span><span class="ticket-id">#{{ ticket.key|stringformat:"s"|slice:"-2:" }}</span> {{ ticket.event.name }}</span>
                    {% if not attendee_must_be_registered %}
                        {% if not ticket.is_used %}
                            <div class="d-flex gap-1 align-items-center">
                                <span class="badge" style="background-color: white !important; color: #198754 !important; border: 1px solid #198754;">Válido</span>
                                {% if ticket.volunteer_ranger or ticket.volunteer_transmutator or ticket.volunteer_umpalumpa or ticket.volunteer_mad %}
                                    {% if ticket.volunteer_ranger %}
                                        <span class="badge" style="font-size: 0.75rem; background-color: #8B4513 !important; color: white !important;">Ranger</span>
                                    {% endif %}
                                    {% if ticket.volunteer_transmutator %}
                                        <span class="badge" style="font-size: 0.75rem; background-color: #9370DB !important; color: white !important;">Transmutador</span>
                                    {% endif %}
                                    {% if ticket.volunteer_umpalumpa %}
                                        <span class="badge" style="font-size: 0.75rem; background-color: #8B0000 !important; color: white !important;">CAOS</span>
                                    {% endif %}
                                    {% if ticket.volunteer_mad %}
                                        <span class="badge" style="font-size: 0.75rem; background-color: #FF8C00 !important; color: white !important;">MAD</span>
                                    {% endif %}
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if not attendee_must_be_registered or ticket.tag == 'Mine' %}
                        <div class="ticket-item mb-4">
                            <div class="d-flex flex-column flex-md-row justify-content-between align-items-start">
                                <div class="ticket-info w-100">
                                    <div class="d-flex flex-column gap-2">
                                        {% if attendee_must_be_registered %}
                                            <div class="text-muted">
                                                <!-- Name line with button on mobile and desktop -->
                                                <div class="d-flex justify-content-between align-items-center mb-1">
                                                    <div class="d-flex align-items-center gap-2">
                                                        <span class="fw-bold">{{ ticket.user_info.first_name }} {{ ticket.user_info.last_name }}</span>
                                                        {% if event.transfers_enabled_until >= now and not ticket.is_used %}
                                                            <button class="btn btn-sm btn-outline-danger d-none d-md-inline-block" onclick="confirmOwnTicketTransfer('{{ ticket.key }}')">
                                                                <i class="fas fa-unlink"></i> Desvincular
                                                            </button>
                                                        {% endif %}
                                                        {% if not attendee_must_be_registered or ticket.tag == 'Mine' %}
                                                            <a href="{% url 'download_ticket_pdf' ticket.key %}" class="btn btn-sm btn-outline-primary d-none d-md-inline-block" target="_blank">
                                                                <i class="fas fa-download"></i> Descargar PDF
                                                            </a>
                                                        {% endif %}
                                                    </div>
                                                    <div class="d-flex align-items-center gap-2 d-md-none">
                                                        {% if event.transfers_enabled_until >= now and not ticket.is_used %}
                                                            <button class="btn btn-sm btn-outline-danger" onclick="confirmOwnTicketTransfer('{{ ticket.key }}')">
                                                                <i class="fas fa-unlink"></i> Desvincular
                                                            </button>
                                                        {% endif %}
                                                        {% if not attendee_must_be_registered or ticket.tag == 'Mine' %}
                                                            <a href="{% url 'download_ticket_pdf' ticket.key %}" class="btn btn-sm btn-outline-primary" target="_blank">
                                                                <i class="fas fa-download"></i> Descargar PDF
                                                            </a>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                
                                                <!-- DNI line -->
                                                <div class="d-flex align-items-center gap-2">
                                                    <span class="fw-bold">DNI: {{ ticket.user_info.dni }}</span>
                                                </div>
                                            </div>
                                        {% else %}
                                            <div class="text-muted d-flex align-items-center gap-2 flex-wrap">
                                                <span class="fw-bold">Invitado</span>
                                                <button class="btn btn-sm btn-semi-white" onclick="shareTicket('{{ ticket.key }}', '{{ ticket.event.name }}')">
                                                    <i class="fas fa-share-alt"></i> Compartir
                                                </button>
                                                <button class="btn btn-sm btn-semi-white" onclick="copyBonoLink('{{ ticket.key }}', event)">
                                                    <i class="fas fa-copy"></i> Copiar link
                                                </button>
                                                {% if not attendee_must_be_registered %}
                                                <a href="{% url 'download_ticket_pdf' ticket.key %}" class="btn btn-sm btn-semi-white" target="_blank" style="text-decoration: none;">
                                                    <i class="fas fa-download"></i> Descargar PDF
                                                </a>
                                                {% endif %}
                                                <a href="https://calendar.google.com/calendar/render?action=TEMPLATE&text={{ ticket.event.name|urlencode }}&dates={{ ticket.event.start|date:'Ymd\THis' }}/{{ ticket.event.end|date:'Ymd\THis' }}&details=Bono: <a href='{{ request.scheme }}://{{ request.get_host }}/bono/{{ ticket.key }}/'>{{ request.scheme }}://{{ request.get_host }}/bono/{{ ticket.key }}/</a>&location={{ ticket.event.location|urlencode }}" 
                                                   target="_blank" 
                                                   class="btn btn-sm btn-semi-white"
                                                   style="text-decoration: none;">
                                                    <i class="fas fa-calendar-plus"></i> Agendar
                                                </a>
                                            </div>
                                        {% endif %}
                                        <div class="ticket-details mt-2">
                                            {% if ticket.event.location %}
                                            <div class="d-flex align-items-center gap-2 mb-2">
                                                <i class="fas fa-map-marker-alt text-muted"></i>
                                                <span class="text-muted">
                                                    {% if ticket.event.location_url %}
                                                        <a href="{{ ticket.event.location_url }}" target="_blank" class="location-link">
                                                            {{ ticket.event.location|safe }}
                                                        </a>
                                                    {% else %}
                                                        {{ ticket.event.location|safe }}
                                                    {% endif %}
                                                </span>
                                            </div>
                                            {% endif %}
                                            <div class="d-flex align-items-center gap-2 mb-2">
                                                <i class="fas fa-calendar-alt text-muted"></i>
                                                <span class="text-muted">{{ ticket.event.start|date:"d/m/Y H:i" }}</span>
                                            </div>
                                            <div class="d-flex align-items-center gap-2 mb-2">
                                                <i class="fas fa-tag text-muted"></i>
                                                <span class="text-muted">{{ ticket.ticket_type }} - ${{ ticket.price|floatformat:0|intcomma }}</span>
                                            </div>
                                            {% if ticket.volunteer_ranger or ticket.volunteer_transmutator or ticket.volunteer_umpalumpa or ticket.volunteer_mad %}
                                            <div class="d-flex flex-column gap-1 mt-2 pt-2 border-top">
                                                <small class="text-muted fw-bold mb-1">Voluntariados:</small>
                                                <div class="d-flex flex-wrap gap-2">
                                                    {% if ticket.volunteer_ranger %}
                                                    <span class="badge" style="background-color: #8B4513 !important; color: white !important;">Ranger</span>
                                                    {% endif %}
                                                    {% if ticket.volunteer_transmutator %}
                                                    <span class="badge" style="background-color: #9370DB !important; color: white !important;">Transmutador</span>
                                                    {% endif %}
                                                    {% if ticket.volunteer_umpalumpa %}
                                                    <span class="badge" style="background-color: #8B0000 !important; color: white !important;">CAOS</span>
                                                    {% endif %}
                                                    {% if ticket.volunteer_mad %}
                                                    <span class="badge" style="background-color: #FF8C00 !important; color: white !important;">MAD</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% endif %}
                                            {% if event_terms %}
                                            <div class="d-flex flex-column gap-1 mt-2 pt-2 border-top">
                                                <small class="text-muted fw-bold mb-1">Términos y Condiciones:</small>
                                                {% for term in event_terms %}
                                                <div class="d-flex align-items-center gap-2">
                                                    <i class="fas fa-file-contract text-muted" style="font-size: 0.875rem;"></i>
                                                    {% if term.description %}
                                                    <a href="{% url 'view_term_description' term.slug %}" target="_blank" class="text-decoration-none text-primary small">
                                                        {{ term.title }}
                                                    </a>
                                                    {% else %}
                                                    <span class="small">{{ term.title }}</span>
                                                    {% endif %}
                                                </div>
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                            {% if ticket.has_ingreso_anticipado or ticket.has_late_checkout or ticket.restriccion %}
                                            <div class="d-flex flex-column gap-1 mt-2 pt-2 border-top">
                                                {% if ticket.has_ingreso_anticipado %}
                                                <div class="d-flex align-items-center gap-2 mb-1">
                                                    <i class="fas fa-clock text-info" style="font-size: 0.875rem;"></i>
                                                    <div class="small">
                                                        <strong class="text-info">Ingreso Anticipado:</strong>
                                                        {% if ticket.ingreso_anticipado_fecha %}
                                                            Podés ingresar desde el <strong>{{ ticket.ingreso_anticipado_fecha }}</strong>
                                                        {% elif ticket.ingreso_anticipado_desde %}
                                                            Podés ingresar desde el <strong>{{ ticket.ingreso_anticipado_desde }}</strong>
                                                        {% else %}
                                                            Tenés ingreso anticipado habilitado
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                {% endif %}
                                                {% if ticket.has_late_checkout %}
                                                <div class="d-flex align-items-center gap-2 mb-1">
                                                    <i class="fas fa-door-open text-success" style="font-size: 0.875rem;"></i>
                                                    <div class="small">
                                                        <strong class="text-success">Late Checkout:</strong>
                                                        {% if ticket.late_checkout_hasta %}
                                                            Podés salir hasta el <strong>{{ ticket.late_checkout_hasta }}</strong>
                                                        {% else %}
                                                            Tenés late checkout habilitado
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                {% endif %}
                                                {% if ticket.restriccion %}
                                                    {% if ticket.has_ingreso_anticipado or ticket.has_late_checkout %}
                                                    <div class="d-flex align-items-center gap-2">
                                                        <i class="fas fa-utensils text-warning" style="font-size: 0.875rem;"></i>
                                                        <div class="small d-flex align-items-center gap-2 flex-wrap">
                                                            <strong class="text-warning">Restricción Alimentaria:</strong>
                                                            <select 
                                                                class="form-select form-select-sm restriccion-select-ticket" 
                                                                data-ticket-key="{{ ticket.key }}"
                                                                style="width: auto; display: inline-block; min-width: 150px;"
                                                            >
                                                                <option value="sin_restricciones" {% if ticket.restriccion == 'sin_restricciones' %}selected{% endif %}>Sin Restricciones</option>
                                                                <option value="vegetarian" {% if ticket.restriccion == 'vegetarian' %}selected{% endif %}>Vegetarian</option>
                                                                <option value="sin_tacc" {% if ticket.restriccion == 'sin_tacc' %}selected{% endif %}>Sin TACC</option>
                                                                <option value="particular" {% if ticket.restriccion == 'particular' %}selected{% endif %}>Particular</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                {% endif %}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="qr-container my-3 my-md-0 mx-auto">
                                    <div class="qr d-flex flex-column align-items-center">
                                        {% if ticket.has_all_terms_accepted %}
                                            <img src="data:image/png;base64,{{ ticket.qr_code }}"
                                                 class="img-fluid"
                                                 alt="QR Code"/>
                                            <div class="text-center mt-2">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <small class="text-muted">{{ ticket.key|last_uuid_part }}</small>
                                                    </div>
                                                </div>
                                            </div>
                                        {% else %}
                                            <div class="d-flex flex-column align-items-center justify-content-center p-4 border rounded bg-light" style="min-height: 200px; min-width: 200px;">
                                                <i class="fas fa-exclamation-triangle text-warning mb-3" style="font-size: 3rem;"></i>
                                                <p class="text-center text-danger fw-bold mb-0">
                                                    Términos y condiciones no aceptadas
                                                </p>
                                                <p class="text-center text-muted mb-0 small">
                                                    Bono inválido
                                                </p>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex flex-column flex-md-row justify-content-between align-items-start">
                                <div class="ticket-actions w-100">
                                    <div class="d-flex flex-column gap-2">
                                        {% if ticket.is_transfer_pending %}
                                            <div class="d-flex align-items-center gap-2">
                                                <span class="notice badge bg-warning text-dark">Invitación pendiente</span>
                                                <span class="text-muted">{{ ticket.transferring_to }}</span>
                                                {% if event.transfers_enabled_until >= now and not ticket.is_used %}
                                                    <button class="btn btn-sm btn-outline-danger" onclick="cancelTicketTransfer('{{ ticket.key }}')">
                                                        Cancelar invitación
                                                    </button>
                                                {% endif %}
                                            </div>
                                        {% else %}
                                            {% if event.transfers_enabled_until >= now and not ticket.is_used %}
                                                <div>
                                                    {% if ticket.tag != 'Mine' %}
                                                        {% if attendee_must_be_registered %}
                                                            <div class="d-flex gap-2">
                                                                <button class="btn btn-sm btn-outline-secondary transfer-ticket" data-ticket-key="{{ ticket.key }}" data-bs-toggle="modal" data-bs-target="#transferModal">
                                                                    Transferir bono
                                                                </button>
                                                            </div>
                                                        {% endif %}
                                                    {% endif %}
                                                </div>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <!-- Guest ticket with transfer functionality -->
                        <div class="ticket-item mb-4">
                            <div class="d-flex flex-column flex-md-row justify-content-between align-items-start">
                                <div class="ticket-info w-100">
                                    <div class="d-flex flex-column gap-2">
                                        <div class="text-muted d-flex align-items-center gap-2">
                                            <span class="fw-bold">Bono Adicional</span>
                                            {% if ticket.is_transfer_pending %}
                                                <span class="badge bg-warning" style="color: black !important;">Invitación pendiente</span>
                                            {% elif ticket.is_transfer_completed %}
                                                <span class="badge bg-success" style="color: white !important;">Transferido</span>
                                            {% else %}
                                                <span class="badge bg-secondary" style="color: white !important;">Sin vincular</span>
                                                {% if not my_ticket and not ticket.is_used %}
                                                    <a class="btn btn-sm btn-outline-success text-success" href="{% url 'assign_ticket' ticket.key %}?next={{ request.get_full_path|urlencode }}" style="color: #198754 !important;">
                                                        <i class="fas fa-link" style="color: #198754 !important;"></i> Vincular
                                                    </a>
                                                {% endif %}
                                                {% if attendee_must_be_registered and event.transfers_enabled_until >= now and not ticket.is_used %}
                                                    <button class="btn btn-sm btn-semi-white" data-bs-toggle="modal" data-bs-target="#transferModal" onclick="setTransferTicketId('{{ ticket.key }}')">
                                                        <i class="fas fa-share-alt"></i> Transferir
                                                    </button>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                        {% if not ticket.is_transfer_pending and not ticket.is_transfer_completed and not attendee_must_be_registered %}
                                            <div class="text-muted d-flex align-items-center gap-2 mt-2 flex-wrap">
                                                <button class="btn btn-sm btn-semi-white" onclick="shareTicket('{{ ticket.key }}', '{{ ticket.event.name }}')">
                                                    <i class="fas fa-share-alt"></i> Compartir
                                                </button>
                                                <button class="btn btn-sm btn-semi-white" onclick="copyBonoLink('{{ ticket.key }}', event)">
                                                    <i class="fas fa-copy"></i> Copiar link
                                                </button>
                                                <a href="{% url 'download_ticket_pdf' ticket.key %}" class="btn btn-sm btn-semi-white" target="_blank" style="text-decoration: none;">
                                                    <i class="fas fa-download"></i> Descargar PDF
                                                </a>
                                                <a href="https://calendar.google.com/calendar/render?action=TEMPLATE&text={{ ticket.event.name|urlencode }}&dates={{ ticket.event.start|date:'Ymd\THis' }}/{{ ticket.event.end|date:'Ymd\THis' }}&details=Bono: <a href='{{ request.scheme }}://{{ request.get_host }}/bono/{{ ticket.key }}/'>{{ request.scheme }}://{{ request.get_host }}/bono/{{ ticket.key }}/</a>&location={{ ticket.event.location|urlencode }}" 
                                                   target="_blank" 
                                                   class="btn btn-sm btn-semi-white"
                                                   style="text-decoration: none;">
                                                    <i class="fas fa-calendar-plus"></i> Agendar
                                                </a>
                                            </div>
                                        {% endif %}
                                        <div class="ticket-details mt-2">
                                            {% if ticket.event.location %}
                                            <div class="d-flex align-items-center gap-2 mb-2">
                                                <i class="fas fa-map-marker-alt text-muted"></i>
                                                <span class="text-muted">
                                                    {% if ticket.event.location_url %}
                                                        <a href="{{ ticket.event.location_url }}" target="_blank" class="location-link">
                                                            {{ ticket.event.location|safe }}
                                                        </a>
                                                    {% else %}
                                                        {{ ticket.event.location|safe }}
                                                    {% endif %}
                                                </span>
                                            </div>
                                            {% endif %}
                                            <div class="d-flex align-items-center gap-2 mb-2">
                                                <i class="fas fa-calendar-alt text-muted"></i>
                                                <span class="text-muted">{{ ticket.event.start|date:"d/m/Y H:i" }}</span>
                                            </div>
                                            <div class="d-flex align-items-center gap-2 mb-2">
                                                <i class="fas fa-tag text-muted"></i>
                                                <span class="text-muted">{{ ticket.ticket_type }} - ${{ ticket.price|floatformat:0|intcomma }}</span>
                                            </div>
                                            {% if event_terms %}
                                            <div class="d-flex flex-column gap-1 mt-2 pt-2 border-top">
                                                <small class="text-muted fw-bold mb-1">Términos y Condiciones:</small>
                                                {% for term in event_terms %}
                                                <div class="d-flex align-items-center gap-2">
                                                    <i class="fas fa-file-contract text-muted" style="font-size: 0.875rem;"></i>
                                                    {% if term.description %}
                                                    <a href="{% url 'view_term_description' term.slug %}" target="_blank" class="text-decoration-none text-primary small">
                                                        {{ term.title }}
                                                    </a>
                                                    {% else %}
                                                    <span class="small">{{ term.title }}</span>
                                                    {% endif %}
                                                </div>
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                            {% if ticket.has_ingreso_anticipado or ticket.has_late_checkout or ticket.restriccion %}
                                            <div class="d-flex flex-column gap-1 mt-2 pt-2 border-top">
                                                {% if ticket.has_ingreso_anticipado %}
                                                <div class="d-flex align-items-center gap-2 mb-1">
                                                    <i class="fas fa-clock text-info" style="font-size: 0.875rem;"></i>
                                                    <div class="small">
                                                        <strong class="text-info">Ingreso Anticipado:</strong>
                                                        {% if ticket.ingreso_anticipado_fecha %}
                                                            Podés ingresar desde el <strong>{{ ticket.ingreso_anticipado_fecha }}</strong>
                                                        {% elif ticket.ingreso_anticipado_desde %}
                                                            Podés ingresar desde el <strong>{{ ticket.ingreso_anticipado_desde }}</strong>
                                                        {% else %}
                                                            Tenés ingreso anticipado habilitado
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                {% endif %}
                                                {% if ticket.has_late_checkout %}
                                                <div class="d-flex align-items-center gap-2 mb-1">
                                                    <i class="fas fa-door-open text-success" style="font-size: 0.875rem;"></i>
                                                    <div class="small">
                                                        <strong class="text-success">Late Checkout:</strong>
                                                        {% if ticket.late_checkout_hasta %}
                                                            Podés salir hasta el <strong>{{ ticket.late_checkout_hasta }}</strong>
                                                        {% else %}
                                                            Tenés late checkout habilitado
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                {% endif %}
                                                {% if ticket.restriccion %}
                                                    {% if ticket.has_ingreso_anticipado or ticket.has_late_checkout %}
                                                    <div class="d-flex align-items-center gap-2">
                                                        <i class="fas fa-utensils text-warning" style="font-size: 0.875rem;"></i>
                                                        <div class="small d-flex align-items-center gap-2 flex-wrap">
                                                            <strong class="text-warning">Restricción Alimentaria:</strong>
                                                            <select 
                                                                class="form-select form-select-sm restriccion-select-ticket" 
                                                                data-ticket-key="{{ ticket.key }}"
                                                                style="width: auto; display: inline-block; min-width: 150px;"
                                                            >
                                                                <option value="sin_restricciones" {% if ticket.restriccion == 'sin_restricciones' %}selected{% endif %}>Sin Restricciones</option>
                                                                <option value="vegetarian" {% if ticket.restriccion == 'vegetarian' %}selected{% endif %}>Vegetarian</option>
                                                                <option value="sin_tacc" {% if ticket.restriccion == 'sin_tacc' %}selected{% endif %}>Sin TACC</option>
                                                                <option value="particular" {% if ticket.restriccion == 'particular' %}selected{% endif %}>Particular</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                {% endif %}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="qr-container my-3 my-md-0 mx-auto">
                                    <div class="qr d-flex flex-column align-items-center">
                                        <img src="{% static 'img/logo_black.png' %}" alt="Fuego Austral" class="img-fluid" style="max-width: 120px;"/>
                                        <div class="text-center mt-2">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <small class="text-muted">{{ ticket.key|last_uuid_part }}</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex flex-column flex-md-row justify-content-between align-items-start">
                                <div class="ticket-actions w-100">
                                    <div class="d-flex flex-column gap-2">
                                        {% if ticket.is_transfer_pending %}
                                            <div class="d-flex align-items-center gap-2">
                                                <span class="notice badge bg-warning lh-sm" style="color: black !important;">Invitación pendiente a<br><strong>{{ ticket.transferring_to }}</strong></span>
                                                {% if attendee_must_be_registered and event.transfers_enabled_until >= now and not ticket.is_used %}
                                                    <button class="btn btn-sm btn-danger text-decoration-none" onclick="cancelTicketTransfer('{{ ticket.key }}')">
                                                        Cancelar invitación
                                                    </button>
                                                {% endif %}
                                            </div>
                                        {% elif ticket.is_transfer_completed %}
                                            <div class="d-flex align-items-center gap-2">
                                                <span class="notice badge bg-success lh-sm" style="color: white !important;">Transferencia completa a<br><strong>{{ ticket.transferred_to }}</strong></span>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
                {% if ticket.tag == 'Mine' and attendee_must_be_registered and event.transfers_enabled_until >= now %}
                <div class="alert alert-info text-start mt-2 mb-0" style="font-size: 0.875rem; border-radius: 0 0 0.375rem 0.375rem;">
                    <div class="d-flex align-items-center gap-2">
                        <i class="fas fa-info-circle"></i>
                        <div>
                            Este bono está vinculado a tu cuenta. Si no vas a ir, para transferirlo, tenés que desvincularlo primero.
                        </div>
                    </div>
                </div>
            {% endif %}
            </div>
           
        {% endfor %}
    {% endif %}

    <div class="modal fade" id="transferModal" data-bs-backdrop="static" tabindex="-1" aria-labelledby="transferModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="transferModalLabel">Transferir Bono</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="transferForm">
                        <div class="mb-3">
                            <label for="recipient-email" class="form-label">Correo Electrónico del Destinatario</label>
                            <input type="email" class="form-control" id="recipient-email" placeholder="nombre@ejemplo.com">
                            <div class="invalid-feedback">Por favor, ingresa un correo electrónico válido.</div>
                        </div>
                        <div class="d-flex justify-content-end gap-2">
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-primary" onclick="confirmTransfer()">Confirmar</button>
                        </div>
                    </div>
                    <div id="loadingSpinner" class="flex-column justify-content-center align-items-center" style="display: none">
                        <div class="spinner-border text-primary" role="status"></div>
                        <div class="my-4">Enviando...</div>
                    </div>
                    <div id="transferSuccessMessage" style="display: none">
                        <div class="alert alert-success mb-3">
                            ¡Transferencia exitosa! El bono ha sido transferido correctamente.
                        </div>
                        <div class="d-flex justify-content-center">
                            <button type="button" class="btn btn-primary" onclick="refreshPage()">Aceptar</button>
                        </div>
                    </div>
                    <div id="transferErrorMessage" style="display: none">
                        <div class="alert alert-danger mb-3">
                            <i class="fas fa-exclamation-circle"></i>
                            <span id="error-message-text"></span>
                        </div>
                        <div class="d-flex justify-content-center">
                            <button type="button" class="btn btn-primary" onclick="resetModal()">Volver</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTicketKey = null;

        function setTransferTicketId(ticketId) {
            currentTicketKey = ticketId;
        }

        // Make function globally available
        window.confirmOwnTicketTransfer = function(ticketKey) {
            if (confirm('Este bono está a tu nombre. Desvinculalo para poder transferirselo a otra persona. Si te arrepientes, podés volver a vincularlo.')) {
                // Unassign the ticket and refresh the page
                fetch(`/ticket/${ticketKey}/unassign/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => {
                    if (response.ok) {
                        // Refresh the page to show updated state
                        window.location.reload();
                    } else {
                        alert('Error al desvincular el bono');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al desvincular el bono');
                });
            }
        }

        document.querySelectorAll('.unassign-ticket').forEach(button => {
            button.addEventListener('click', async function () {
                const ticketKey = this.dataset.ticketKey;
                if (confirm('Si no vas a ir, desasigna tu bono para poder transferirselo a otra persona. ¿Estás seguro que no vas a ir?')) {
                    window.location.href = `/ticket/${ticketKey}/unassign/`;
                }
            });
        });

        document.querySelectorAll('.transfer-ticket').forEach(button => {
            button.addEventListener('click', function () {
                currentTicketKey = this.dataset.ticketKey;
            });
        });

        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        async function confirmTransfer() {
            const emailInput = document.getElementById('recipient-email');
            const email = emailInput.value;

            if (!validateEmail(email)) {
                emailInput.classList.add('is-invalid');
                return;
            } else {
                emailInput.classList.remove('is-invalid');
            }

            document.getElementById('transferForm').style.display = 'none';
            document.getElementById('loadingSpinner').style.display = 'flex';

            try {
                const response = await fetch(`/ticket/${currentTicketKey}/transfer/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                    body: JSON.stringify({
                        email: email
                    })
                });

                let responseBody = {};
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    try {
                        responseBody = await response.json();
                    } catch (jsonError) {
                        console.error('Error parsing JSON:', jsonError);
                        document.getElementById('loadingSpinner').style.display = 'none';
                        document.getElementById('error-message-text').textContent = 'Error en la transferencia. Por favor, inténtalo de nuevo.';
                        document.getElementById('transferErrorMessage').style.display = 'block';
                        return;
                    }
                }

                if (response.ok) {
                    document.getElementById('loadingSpinner').style.display = 'none';
                    if (responseBody.destination_user_exists) {
                        document.getElementById('transferSuccessMessage').style.display = 'block';
                    }
                } else {
                    document.getElementById('loadingSpinner').style.display = 'none';
                    // Check if it's an email not found error
                    if (responseBody.error === 'EMAIL_NOT_FOUND') {
                        document.getElementById('error-message-text').textContent = responseBody.message || 'El correo electrónico no fue encontrado. Por favor, verifica que el destinatario tenga una cuenta activa en Fuego Austral.';
                        document.getElementById('transferErrorMessage').style.display = 'block';
                    } else {
                        // Generic error
                        document.getElementById('error-message-text').textContent = responseBody.message || 'Error en la transferencia. Por favor, inténtalo de nuevo.';
                        document.getElementById('transferErrorMessage').style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Error during fetch:', error);
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('error-message-text').textContent = 'Error en la conexión. Por favor, inténtalo de nuevo.';
                document.getElementById('transferErrorMessage').style.display = 'block';
            }
        }

        async function cancelTicketTransfer(ticketKey) {
            if (!confirm('¿Estás seguro de que deseas cancelar la transferencia?')) {
                return;
            }
            try {
                const response = await fetch('{% url "cancel_ticket_transfer" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                    body: JSON.stringify({
                        ticket_key: ticketKey
                    })
                });

                if (response.ok) {
                    refreshPage();
                } else {
                    alert('Error al cancelar la transferencia. Por favor, inténtalo de nuevo.');
                }
            } catch (error) {
                console.error('Error during fetch:', error);
                alert('Error en la conexión. Por favor, inténtalo de nuevo.');
            }
        }

        function refreshPage() {
            // Reload the current page to maintain the event context
            location.reload();
        }

        function resetModal() {
            document.getElementById('transferForm').style.display = 'block';
            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('transferSuccessMessage').style.display = 'none';
            document.getElementById('transferErrorMessage').style.display = 'none';
            document.getElementById('recipient-email').classList.remove('is-invalid');
            document.getElementById('recipient-email').value = '';
        }

        function shareTicket(ticketKey, eventName) {
            const shareUrl = `${window.location.origin}/bono/${ticketKey}/`;
            if (navigator.share) {
                navigator.share({
                    title: 'Bono de ' + eventName,
                    text: 'Te comparto un bono para ' + eventName,
                    url: shareUrl
                })
                .catch(error => console.log('Error sharing:', error));
            } else {
                // Fallback for browsers that don't support Web Share API
                const tempInput = document.createElement('input');
                tempInput.value = shareUrl;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                alert('URL copiada al portapapeles');
            }
        }

        function copyBonoLink(ticketKey, event) {
            const bonoUrl = `${window.location.origin}/bono/${ticketKey}/`;
            navigator.clipboard.writeText(bonoUrl)
                .then(() => {
                    const button = event.target.closest('button');
                    const originalText = button.innerHTML;
                    button.innerHTML = '<i class="fas fa-check"></i> Copiado!';
                    setTimeout(() => {
                        button.innerHTML = originalText;
                    }, 2000);
                })
                .catch(err => {
                    console.error('Error al copiar:', err);
                    alert('Error al copiar el link');
                });
        }

        // Auto-refresh functionality - Version 2025-01-15-01:30
        let autoRefreshInterval;
        let isAutoRefreshEnabled = true;
        let lastUpdateTime = new Date().toISOString();
        let initialTicketStates = {}; // Store initial states from Django
        let currentTicketStates = {}; // Store current states to detect changes

        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            autoRefreshInterval = setInterval(async () => {
                if (isAutoRefreshEnabled) {
                    await checkForUpdates();
                }
            }, 1000); // Check every second
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        async function checkForUpdates() {
            try {
                const eventSlug = '{{ event.slug }}';
                if (!eventSlug) {
                    return;
                }

                // Add cache-busting parameter and last update time
                const timestamp = new Date().getTime();
                const lastUpdateParam = lastUpdateTime ? `&last_update=${encodeURIComponent(lastUpdateTime)}` : '';
                const response = await fetch(`/mi-fuego/mis-bonos/${eventSlug}/ajax/?t=${timestamp}${lastUpdateParam}`, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Cache-Control': 'no-cache',
                    },
                });

                if (response.ok) {
                    const data = await response.json();
                    updateTicketStatus(data);
                    lastUpdateTime = data.now;
                }
            } catch (error) {
console.error('Error checking for updates:', error);
            }
        }

        function updateTicketStatus(data) {
            // Check if we have tickets data
            if (!data.tickets) {
                return;
            }

            // Store initial states on first load
            if (Object.keys(initialTicketStates).length === 0) {
                data.tickets.forEach(ticket => {
                    initialTicketStates[ticket.key] = {
                        is_used: ticket.is_used
                    };
                });
            }

            // Update each ticket's status
            data.tickets.forEach((ticket, index) => {
                const ticketElement = document.querySelector(`[data-ticket-key="${ticket.key}"]`);
                if (ticketElement) {
                    updateTicketElement(ticketElement, ticket);
                }
            });
        }

        function updateTicketElement(ticketElement, ticket) {
            // Check if there are any actual changes to avoid unnecessary updates
            const currentState = currentTicketStates[ticket.key];
            const hasChanges = !currentState || 
                currentState.is_used !== ticket.is_used || 
                currentState.owner !== ticket.owner ||
                currentState.volunteer_ranger !== ticket.volunteer_ranger ||
                currentState.volunteer_transmutator !== ticket.volunteer_transmutator ||
                currentState.volunteer_umpalumpa !== ticket.volunteer_umpalumpa ||
                currentState.volunteer_mad !== ticket.volunteer_mad ||
                currentState.is_transfer_completed !== ticket.is_transfer_completed ||
                currentState.is_transfer_pending !== ticket.is_transfer_pending;
            
            if (!hasChanges) {
                return;
            }
            
            // Update current state
            if (!currentTicketStates[ticket.key]) {
                currentTicketStates[ticket.key] = {};
            }
            currentTicketStates[ticket.key].is_used = ticket.is_used;
            currentTicketStates[ticket.key].owner = ticket.owner;
            currentTicketStates[ticket.key].volunteer_ranger = ticket.volunteer_ranger;
            currentTicketStates[ticket.key].volunteer_transmutator = ticket.volunteer_transmutator;
            currentTicketStates[ticket.key].volunteer_umpalumpa = ticket.volunteer_umpalumpa;
            currentTicketStates[ticket.key].volunteer_mad = ticket.volunteer_mad;
            currentTicketStates[ticket.key].is_transfer_completed = ticket.is_transfer_completed;
            currentTicketStates[ticket.key].is_transfer_pending = ticket.is_transfer_pending;
            
            // Update used status
            const header = ticketElement.querySelector('.card-header');
            // Look for badge or volunteer badges container
            const badge = ticketElement.querySelector('.card-header .badge:not([style*="background-color: #8B4513"]):not([style*="background-color: #9370DB"]):not([style*="background-color: #8B0000"]):not([style*="background-color: #FF8C00"]):not(.bg-primary):not(.bg-info):not(.bg-warning)');
            const volunteerBadgesContainer = ticketElement.querySelector('.card-header .d-flex.gap-1');
            
            if (ticket.is_used) {
                if (header) {
                    // Remove all background classes - used tickets have no background color
                    header.classList.remove('bg-success', 'bg-dark', 'text-white');
                }
                
                // "USADO" tag is rendered natively in the template
                
                // Hide the "Desvincular" buttons for already used tickets (not during animation)
                const unlinkButtons = ticketElement.querySelectorAll('button[onclick*="confirmOwnTicketTransfer"]');
                unlinkButtons.forEach(button => {
                    console.log('Hiding button:', button, 'Classes:', button.className);
                    button.classList.add('force-hidden');
                });
                
            } else {
                // Check if this is an unassigned ticket (no owner)
                const isUnassigned = !ticket.owner || ticket.owner === null;
                
                if (header) {
                    // Add green background for valid tickets
                    header.classList.remove('bg-dark', 'bg-success', 'text-white');
                    header.classList.add('bg-success', 'text-white');
                }
                
                    // Check if ticket has volunteer roles
                    const hasVolunteerRoles = ticket.volunteer_ranger || ticket.volunteer_transmutator || ticket.volunteer_umpalumpa || ticket.volunteer_mad;
                
                // Find existing "Válido" badge to avoid recreating it unnecessarily
                const existingValidBadge = header.querySelector('.badge[style*="color: #198754"], .badge:not([style*="background-color: #8B4513"]):not([style*="background-color: #9370DB"]):not([style*="background-color: #8B0000"]):not(.bg-primary):not(.bg-info):not(.bg-warning):not(.bg-secondary)');
                const validBadgeExists = existingValidBadge && existingValidBadge.textContent.trim() === 'Válido';
                
                if (isUnassigned) {
                    // Unassigned ticket - remove volunteer badges if they exist, show "Sin vincular" only if not transferred
                    // Remove "Válido" badge if it exists
                    if (existingValidBadge && validBadgeExists) {
                        existingValidBadge.remove();
                    }
                    // Remove volunteer badges container if it exists
                    if (volunteerBadgesContainer) {
                        volunteerBadgesContainer.remove();
                    }
                    
                    // Don't show "Sin vincular" if ticket is transferred
                    if (!ticket.is_transfer_completed && !ticket.is_transfer_pending) {
                        if (badge && badge.textContent.trim() !== 'Sin vincular') {
                            badge.textContent = 'Sin vincular';
                            badge.className = 'badge bg-secondary';
                            badge.style.cssText = 'color: white !important;';
                        } else if (!badge) {
                            // Create badge if it doesn't exist
                            const newBadge = document.createElement('span');
                            newBadge.className = 'badge bg-secondary';
                            newBadge.style.cssText = 'color: white !important;';
                            newBadge.textContent = 'Sin vincular';
                            // Insert at the end of header (right side)
                            header.appendChild(newBadge);
                        }
                    } else {
                        // If transferred, remove "Sin vincular" badge if it exists
                        if (badge && badge.textContent.trim() === 'Sin vincular') {
                            badge.remove();
                        }
                    }
                } else {
                    // Valid assigned ticket - show "Válido" badge
                    // Only create or update if it doesn't exist or is incorrect
                    if (!validBadgeExists) {
                        // Remove existing badge if it's not "Válido"
                        if (badge && badge.textContent.trim() !== 'Válido') {
                            badge.remove();
                        }
                        
                        // Create "Válido" badge if it doesn't exist
                        const validBadge = document.createElement('span');
                        validBadge.className = 'badge';
                        validBadge.style.cssText = 'background-color: white !important; color: #198754 !important; border: 1px solid #198754;';
                        validBadge.textContent = 'Válido';
                        
                        // Check if there's already a container with badges
                        let badgeContainer = header.querySelector('.d-flex.gap-1');
                        if (badgeContainer) {
                            // Insert at the beginning of existing container
                            badgeContainer.insertBefore(validBadge, badgeContainer.firstChild);
                        } else {
                            // Create new container
                            badgeContainer = document.createElement('div');
                            badgeContainer.className = 'd-flex gap-1 align-items-center';
                            badgeContainer.appendChild(validBadge);
                            
                            // Insert at the end of header (right side)
                            header.appendChild(badgeContainer);
                        }
                    }
                    // If badge already exists and is correct, don't touch it
                    
                    // Handle volunteer badges - only update if there are changes
                    const currentVolunteerState = currentTicketStates[ticket.key] ? {
                        ranger: currentTicketStates[ticket.key].volunteer_ranger,
                        transmutator: currentTicketStates[ticket.key].volunteer_transmutator,
                        umpalumpa: currentTicketStates[ticket.key].volunteer_umpalumpa,
                        mad: currentTicketStates[ticket.key].volunteer_mad
                    } : null;
                    
                    const volunteerStateChanged = !currentVolunteerState || 
                        currentVolunteerState.ranger !== ticket.volunteer_ranger ||
                        currentVolunteerState.transmutator !== ticket.volunteer_transmutator ||
                        currentVolunteerState.umpalumpa !== ticket.volunteer_umpalumpa ||
                        currentVolunteerState.mad !== ticket.volunteer_mad;
                    
                    if (volunteerStateChanged) {
                        // Get or create badge container
                        let badgeContainer = header.querySelector('.d-flex.gap-1');
                        if (!badgeContainer) {
                            badgeContainer = document.createElement('div');
                            badgeContainer.className = 'd-flex gap-1 align-items-center';
                            // Get the existing "Válido" badge if it exists
                            const existingValid = header.querySelector('.badge[style*="color: #198754"], .badge:not([style*="background-color: #8B4513"]):not([style*="background-color: #9370DB"]):not([style*="background-color: #8B0000"]):not([style*="background-color: #FF8C00"]):not(.bg-primary):not(.bg-info):not(.bg-warning):not(.bg-secondary)');
                            if (existingValid && existingValid.textContent.trim() === 'Válido') {
                                // Move existing badge to container
                                existingValid.remove();
                                badgeContainer.appendChild(existingValid);
                            }
                            // Insert at the end of header (right side)
                            header.appendChild(badgeContainer);
                        }
                        
                        if (hasVolunteerRoles) {
                            // Remove existing volunteer badges only
                            const existingVolunteerBadges = badgeContainer.querySelectorAll('.badge[style*="background-color: #8B4513"], .badge[style*="background-color: #9370DB"], .badge[style*="background-color: #8B0000"], .badge[style*="background-color: #FF8C00"], .badge.bg-primary, .badge.bg-info, .badge.bg-warning');
                            existingVolunteerBadges.forEach(b => b.remove());
                            
                            // Add volunteer badges
                            const volunteerBadges = [];
                            if (ticket.volunteer_ranger) {
                                volunteerBadges.push('<span class="badge" style="font-size: 0.75rem; background-color: #8B4513 !important; color: white !important;">Ranger</span>');
                            }
                            if (ticket.volunteer_transmutator) {
                                volunteerBadges.push('<span class="badge" style="font-size: 0.75rem; background-color: #9370DB !important; color: white !important;">Transmutador</span>');
                            }
                            if (ticket.volunteer_umpalumpa) {
                                volunteerBadges.push('<span class="badge" style="font-size: 0.75rem; background-color: #8B0000 !important; color: white !important;">CAOS</span>');
                            }
                            if (ticket.volunteer_mad) {
                                volunteerBadges.push('<span class="badge" style="font-size: 0.75rem; background-color: #FF8C00 !important; color: white !important;">MAD</span>');
                            }
                            
                            if (volunteerBadges.length > 0) {
                                badgeContainer.insertAdjacentHTML('beforeend', volunteerBadges.join(''));
                            }
                        } else {
                            // No volunteer roles - remove volunteer badges if they exist
                            const existingVolunteerBadges = badgeContainer.querySelectorAll('.badge.bg-primary, .badge.bg-info, .badge.bg-warning');
                            existingVolunteerBadges.forEach(b => b.remove());
                            
                            // If container only has "Válido" badge, we can keep it as is
                            // If container becomes empty, remove it and use standalone badge
                            if (badgeContainer.children.length === 0) {
                                badgeContainer.remove();
                            }
                        }
                    }
                }
                
                // Show the "Desvincular" buttons when ticket is not used
                const unlinkButtons = ticketElement.querySelectorAll('button[onclick*="confirmOwnTicketTransfer"]');
                unlinkButtons.forEach(button => {
                    button.classList.remove('force-hidden');
                });
            }

            // Update transfer status
            const transferBadge = ticketElement.querySelector('.notice.badge');
            if (transferBadge) {
                if (ticket.is_transfer_pending) {
                    transferBadge.textContent = 'Invitación pendiente';
                    transferBadge.className = 'notice badge bg-warning text-dark';
                } else if (ticket.is_transfer_completed) {
                    transferBadge.textContent = 'Transferido';
                    transferBadge.className = 'notice badge bg-success';
                    transferBadge.style.cssText = 'color: white !important;';
                }
            }
            
            // Store current state for next comparison (already updated above, but keep for consistency)
            if (!currentTicketStates[ticket.key]) {
                currentTicketStates[ticket.key] = {};
            }
            currentTicketStates[ticket.key].is_used = ticket.is_used;
            currentTicketStates[ticket.key].owner = ticket.owner;
            currentTicketStates[ticket.key].volunteer_ranger = ticket.volunteer_ranger;
            currentTicketStates[ticket.key].volunteer_transmutator = ticket.volunteer_transmutator;
            currentTicketStates[ticket.key].volunteer_umpalumpa = ticket.volunteer_umpalumpa;
            currentTicketStates[ticket.key].volunteer_mad = ticket.volunteer_mad;
            currentTicketStates[ticket.key].is_transfer_completed = ticket.is_transfer_completed;
            currentTicketStates[ticket.key].is_transfer_pending = ticket.is_transfer_pending;
            
            // Trigger animation ONLY if:
            // - ticket is now used AND
            // - initial state was not used AND  
            // - current state was not used (first time changing to used)
            const initialState = initialTicketStates[ticket.key];
            const wasNotUsedInitially = initialState && !initialState.is_used;
            const isNowUsed = ticket.is_used;
            const wasNotUsedCurrently = currentState && !currentState.is_used;
            
            if (isNowUsed && wasNotUsedInitially && wasNotUsedCurrently) {
                // Hide the "Desvincular" buttons when animation starts
                const unlinkButtons = ticketElement.querySelectorAll('button[onclick*="confirmOwnTicketTransfer"]');
                unlinkButtons.forEach(button => {
                    console.log('Hiding button during animation:', button, 'Classes:', button.className);
                    button.classList.add('force-hidden');
                });
                
                // Show the "USADO" tag
                const badge = ticketElement.querySelector('.badge');
                if (badge) {
                    badge.textContent = 'Usado';
                    badge.className = 'badge bg-secondary';
                    badge.style.cssText = 'color: white !important;';
                }
                
                showFireAnimation(ticketElement);
            }
        }


        function createSwarmElement(container = null) {
            const element = document.createElement('div');
            
            // Array of random emojis
            const emojis = ['🎉', '✨', '🌟', '💫', '⭐', '🎊', '🎈', '🎁', '💎', '🌈', '🦄', '🍀', '🌸', '🌺', '🌻', '🌷', '🌹', '🌼', '🦋', '🐝', '🦆', '🦜', '🦚', '🦩', '🦢', '🦋', '🐞', '🦗', '🕊️', '🦅', '🦉', '🦇', '🦋', '🐛', '🦟', '🦗', '🕷️', '🦂', '🦀', '🦞', '🦐', '🦑', '🐙', '🦈', '🐠', '🐟', '🐡', '🐢', '🦎', '🐍', '🦕', '🦖', '🐊', '🐅', '🐆', '🦓', '🦍', '🦧', '🐘', '🦛', '🦏', '🐪', '🐫', '🦒', '🦘', '🐃', '🐂', '🐄', '🐎', '🐖', '🐏', '🐑', '🦙', '🐐', '🦌', '🐕', '🐩', '🦮', '🐕‍🦺', '🐈', '🐓', '🦃', '🦚', '🦜', '🦢', '🦩', '🕊️', '🐇', '🦝', '🦨', '🦡', '🦦', '🦥', '🐁', '🐀', '🐿️', '🦔'];
            
            // Pick a random emoji
            const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
            element.textContent = randomEmoji;
            element.className = 'swarm-element emoji';
            
            // If container is provided, animate within that container
            if (container) {
                const containerRect = container.getBoundingClientRect();
                const startX = Math.random() * containerRect.width;
                const endX = Math.random() * containerRect.width;
                const endY = containerRect.height + 100;
                
                element.style.setProperty('--x-start', `${startX}px`);
                element.style.setProperty('--x-end', `${endX}px`);
                element.style.setProperty('--y-end', `${endY}px`);
                
                // Position relative to container
                element.style.position = 'absolute';
                element.style.top = '0';
                element.style.left = '0';
                
                container.appendChild(element);
            } else {
                // Random start position across the width of the screen
                const startX = Math.random() * window.innerWidth;
                
                // Random end position (also across width and to bottom)
                const endX = Math.random() * window.innerWidth;
                const endY = window.innerHeight + 100;
                
                element.style.setProperty('--x-start', `${startX}px`);
                element.style.setProperty('--x-end', `${endX}px`);
                element.style.setProperty('--y-end', `${endY}px`);
                
                document.body.appendChild(element);
            }
            
            // Remove element after animation
            setTimeout(() => {
                element.remove();
            }, 3000);
        }

        function triggerSwarm(container = null) {
            // Create 200 elements with slower delays for a more gradual animation
            for (let i = 0; i < 200; i++) {
                setTimeout(() => {
                    createSwarmElement(container);
                }, i * 80);
            }
        }

        function showFireAnimation(container = null) {
            triggerSwarm(container);
        }


        function showUpdateIndicator() {
            // Create or update a subtle indicator
            let indicator = document.getElementById('update-indicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'update-indicator';
                indicator.style.cssText = `
                    position: fixed;
                    top: 10px;
                    right: 10px;
                    background: rgba(0, 123, 255, 0.8);
                    color: white;
                    padding: 5px 10px;
                    border-radius: 15px;
                    font-size: 12px;
                    z-index: 9999;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                `;
                document.body.appendChild(indicator);
            }
            
            indicator.textContent = 'Actualizado';
            indicator.style.opacity = '1';
            
            setTimeout(() => {
                indicator.style.opacity = '0';
            }, 1000);
        }

        // Verify that ticket elements have data attributes and initialize current states
        function verifyTicketDataAttributes() {
            const cards = document.querySelectorAll('.card[data-ticket-key]');
            // Initialize current states for all tickets
            cards.forEach(card => {
                const ticketKey = card.getAttribute('data-ticket-key');
                const badge = card.querySelector('.badge');
                const isUsed = badge && badge.textContent === 'Usado';
                
                if (ticketKey) {
                    currentTicketStates[ticketKey] = {
                        is_used: isUsed,
                        owner: null // We'll get this from the first AJAX call
                    };
                }
            });
        }


        // Initialize auto-refresh when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Only start auto-refresh if we're on a specific event page
            const eventSlug = '{{ event.slug }}';
            if (eventSlug && eventSlug !== 'eventos-anteriores') {
                startAutoRefresh();
                
                // Verify that ticket elements have data attributes
                verifyTicketDataAttributes();
                
                // Tags "USADO" are now rendered natively in the template
                
                // Pause auto-refresh when user is interacting with modals
                document.addEventListener('show.bs.modal', function() {
                    isAutoRefreshEnabled = false;
                });
                
                document.addEventListener('hide.bs.modal', function() {
                    isAutoRefreshEnabled = true;
                });
                
                // Pause auto-refresh when page is not visible
                document.addEventListener('visibilitychange', function() {
                    if (document.hidden) {
                        isAutoRefreshEnabled = false;
                    } else {
                        isAutoRefreshEnabled = true;
                    }
                });
            }
        });

        // Clean up when page unloads
        window.addEventListener('beforeunload', function() {
            stopAutoRefresh();
        });

        // Handle restriccion select changes
        document.querySelectorAll('.restriccion-select-ticket').forEach(function(select) {
            select.addEventListener('change', function() {
                const ticketKey = this.dataset.ticketKey;
                const restriccion = this.value;
                const originalValue = this.dataset.originalValue || this.value;
                
                // Disable select while processing
                this.disabled = true;
                
                fetch(`/mi-fuego/ticket/${ticketKey}/update-restriccion/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: new URLSearchParams({
                        'restriccion': restriccion
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update original value
                        this.dataset.originalValue = restriccion;
                        // Show success message (you can customize this)
                        console.log(data.message);
                    } else {
                        // Revert to original value
                        this.value = originalValue;
                        alert(data.error || 'Error al actualizar restricción');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    this.value = originalValue;
                    alert('Error al actualizar restricción');
                })
                .finally(() => {
                    this.disabled = false;
                });
            });
            
            // Store original value on load
            select.dataset.originalValue = select.value;
        });
    </script>
{% endblock truecontent %}
